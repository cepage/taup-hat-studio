@if (loading()) {
  <div class="loading">
    <mat-spinner diameter="40" />
    <span>Loading...</span>
  </div>
} @else if (issue(); as iss) {
  <div class="header">
    <div class="header-left">
      <a mat-icon-button [routerLink]="['/webcomics', seriesId]" class="back-button" aria-label="Back to issue list">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <div>
        <p class="breadcrumb">{{ seriesTitle() }}</p>
        <h1>
          <span class="issue-number">#{{ iss.issueNumber }}</span>
          {{ iss.title }}
        </h1>
        <p class="subtitle">
          {{ pages().length }} page{{ pages().length !== 1 ? 's' : '' }}
          <mat-chip-set aria-label="Issue status">
            @if (iss.published) {
              <mat-chip color="tertiary" highlighted>Published</mat-chip>
            } @else {
              <mat-chip>Draft</mat-chip>
            }
          </mat-chip-set>
        </p>
      </div>
    </div>
    <div class="actions">
      <button mat-button (click)="editIssue()">
        <mat-icon>edit</mat-icon>
        Edit Issue
      </button>
      <button mat-fab extended (click)="triggerFileUpload()">
        <mat-icon>upload</mat-icon>
        Upload Pages
      </button>
      <input
        #fileInput
        type="file"
        accept="image/*"
        multiple
        hidden
        (change)="onFilesSelected($event)"
      />
    </div>
  </div>

  @if (uploading()) {
    <mat-progress-bar mode="determinate" [value]="uploadProgress()" />
    <p class="upload-status">
      Uploading {{ uploadCurrent() }} of {{ uploadTotal() }}...
    </p>
  }

  @if (pages().length === 0 && !uploading()) {
    <app-empty-state icon="image" title="No pages yet" description="Upload images to add pages to this issue.">
      <button mat-flat-button (click)="triggerFileUpload()" actions>
        <mat-icon>upload</mat-icon>
        Upload Pages
      </button>
    </app-empty-state>
  } @else {
    <div class="page-grid">
      @for (page of pages(); track page.id) {
        <div class="page-card">
          <div class="page-image">
            <img
              [src]="page.thumbnailUrl || page.optimizedUrl || page.imageUrl"
              [alt]="'Page ' + page.pageNumber"
            />
          </div>
          <div class="page-info">
            <span class="page-number">Page {{ page.pageNumber }}</span>
            <div class="page-actions">
              @if (!$first) {
                <button mat-icon-button (click)="movePage($index, -1)" aria-label="Move page left">
                  <mat-icon>chevron_left</mat-icon>
                </button>
              }
              @if (!$last) {
                <button mat-icon-button (click)="movePage($index, 1)" aria-label="Move page right">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              }
              <button mat-icon-button color="warn" (click)="confirmDeletePage(page)" aria-label="Delete page">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }
}
